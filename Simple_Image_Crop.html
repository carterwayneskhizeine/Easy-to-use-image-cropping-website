<!DOCTYPE html>
<html>
<head>
  <title>图像编辑器与比例计算器</title>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">
  <style>
    /* 通用样式 */
    body {
      font-family: sans-serif;
      display: flex;
      flex-direction: column;
      align-items: center;
      background-color: #f5f5f5;
      margin: 0;
      padding: 20px;
      user-select: none;
      transition: all 0.3s ease;
    }
    /* 切换容器 */
    .tab-container {
      width: 100%;
      max-width: 600px;
    }
    /* 切换按钮 */
    .tab-button {
      width: 100%;
      max-width: 600px;
      display: flex;
      justify-content: center;
      align-items: center; /* 新增：垂直居中 */
      margin-bottom: 20px;
    }
    .tab-button button {
      background-color: #4285f4;
      color: #fff;
      border: none;
      padding: 10px 20px;
      border-radius: 25px;
      font-size: 16px;
      cursor: pointer;
      transition: background-color 0.3s;
      box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
      margin: 0 5px;
    }
    .tab-button button:hover {
      background-color: #3367d6;
    }
    /* 分辨率显示（移到顶部） */
    .resolution-display {
      margin-bottom: 10px;
      font-size: 16px;
    }
    /* 图像编辑器的容器 */
    .container {
      width: 100%;
      max-width: 600px;
      display: flex;
      flex-direction: column;
      align-items: center;
    }
    /* 画布容器 */
    .canvas-container {
      width: 100%;
      max-width: 500px;
      max-height: 500px;
      background-color: #ccc;
      border: 2px solid #ddd;
      border-radius: 10px;
      overflow: hidden;
      position: relative;
      margin-bottom: 20px;
      cursor: move; /* 显示移动光标 */
    }
    #previewImage {
      width: 100%;
      height: 100%;
      object-fit: contain;
      position: absolute;
      left: 0;
      top: 0;
      display: none; /* 初始隐藏，加载图片后显示 */
    }
    .controls {
      width: 100%;
      display: flex;
      flex-direction: column;
      gap: 10px;
    }
    .button-group {
      display: flex;
      justify-content: space-around;
      flex-wrap: wrap;
      gap: 10px;
    }
    button {
      background-color: #4285f4;
      color: #fff;
      border: none;
      padding: 10px 20px;
      border-radius: 25px;
      font-size: 16px;
      cursor: pointer;
      transition: background-color 0.3s;
      box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
    }
    button:hover {
      background-color: #3367d6;
    }
    .input-group {
      display: flex;
      align-items: center;
      gap: 10px;
    }
    input[type="number"] {
      width: 80px;
      padding: 8px;
      border: 1px solid #ddd;
      border-radius: 5px;
      font-size: 16px;
    }
    #downloadBtn {
      background-color: #0f9d58;
      margin-top: 0;
    }
    #downloadBtn:hover {
      background-color: #0b8043;
    }
    #copyToClipboardBtn {
      background-color: #42b9f4;
      margin-top: 0;
    }
    #copyToClipboardBtn:hover {
      background-color: #3ba8e0;
    }
    /* 夜间模式样式 */
    .night-mode {
      background-color: #333;
      color: #ffffff;
    }
    .night-mode .canvas-container {
      border-color: #555;
    }
    .night-mode button {
      background-color: #555;
    }
    .night-mode button:hover {
      background-color: #777;
    }
    /* 比例计算器样式 */
    .calculator {
      display: none; /* 初始隐藏 */
      border: 1px solid #ccc;
      padding: 20px;
      border-radius: 5px;
      transition: all 0.3s ease;
      position: relative;
      padding-top: 20px; /* 调整比例计算器的顶部内边距 */
      max-width: 600px;
      width: 100%;
    }
    .calculator .input-group {
      margin: 10px 0;
    }
    .calculator input {
      width: 100px;
      padding: 5px;
      transition: all 0.3s ease;
    }
    .night-mode .calculator {
      border-color: #555;
      background-color: #444;
    }
    .night-mode .calculator input {
      background-color: #555;
      color: white;
      border: 1px solid #666;
    }
    /* 开关按钮样式 */
    .switch {
      display: inline-block;
      width: 50px; /* 调整宽度 */
      height: 28px; /* 调整高度 */
      margin-left: 10px;
      vertical-align: middle;
    }
    .switch input {
      opacity: 0;
      width: 0;
      height: 0;
    }
    .slider {
      position: relative;
      cursor: pointer;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background-color: #a2a2a2;
      transition: .4s;
      border-radius: 28px; /* 调整圆角 */
    }
    .slider:before {
      position: absolute;
      content: "";
      height: 20px; /* 调整大小 */
      width: 20px; /* 调整大小 */
      left: 4px;
      bottom: 4px;
      background-color: rgb(0, 93, 200);/* 修改切换夜间模式圆点颜色 */
      transition: .4s;
      border-radius: 50%;
    }
    input[type="checkbox"]:checked + .slider {
      background-color: #4CAF50;
    }
    input[type="checkbox"]:checked + .slider:before {
      transform: translateX(22px); /* 调整滑动距离 */
    }
    /* Responsive Design */
    @media (max-width: 500px) {
      .canvas-container {
        height: 250px;
      }
      .button-group {
        flex-direction: column;
        align-items: center;
      }
      canvas{
        touch-action: none;
      }
    }
    .drop-zone-text {
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      font-size: 18px;
      color: #666;
      pointer-events: none;
      opacity: 0;
      transition: opacity 0.3s;
    }

    .canvas-container:not(:has(#previewImage[src])):hover .drop-zone-text {
      opacity: 1;
    }
  </style>
</head>
<body>
  <div class="tab-button">
    <button onclick="document.getElementById('fileInput').click();" style="margin-right: 50px;">导入图片</button>
    <button id="toggleTabBtn">切换到比例计算器</button>
    <label class="switch">
      <input type="checkbox" id="darkModeToggle">
      <span class="slider"></span>
    </label>
  </div>
  <div class="tab-container">
    <div class="container" id="imageEditor">
      <input type="file" id="fileInput" accept="image/*" style="display: none;">
      <div class="canvas-container" id="dropZone">
        <img id="previewImage" src="" alt="">
        <div class="image-overlay"></div>
        <div class="drop-zone-text">拖拽图片到这里</div>
      </div>
      <div class="controls">
        <div class="resolution-display" style="text-align: center; margin: 10px 0;">当前分辨率: <span>500 x 281</span></div>
        <div class="button-group">
          <button onclick="rotateLeft()">左旋</button>
          <button onclick="rotateRight()">右旋</button>
          <button onclick="zoomInPixel()">放大1px</button>
          <button onclick="zoomOutPixel()">缩小1px</button>
        </div>
        <div class="button-group">
          <button onclick="setResolution(256, 256)">256x256</button>
          <button onclick="setResolution(512, 512)">512x512</button>
          <button onclick="setResolution(1024, 1024)">1024x1024</button>
          <button onclick="setResolution(2048, 2048)">2048x2048</button>
        </div>
        <div class="input-group" style="justify-content: center;">
          <span>自定义分辨率:</span>
          <input type="number" id="customWidth" placeholder="宽度">
          x
          <input type="number" id="customHeight" placeholder="高度">
          <button onclick="setCustomResolution()">应用</button>
        </div>
        <div class="button-group">
          <button onclick="setAspectRatio(16, 9)">16:9</button>
          <button onclick="setAspectRatio(9, 16)">9:16</button>
          <button onclick="setAspectRatio(4, 3)">4:3</button>
          <button onclick="setAspectRatio(1, 1)">1:1</button>
        </div>
        <div class="button-group">
          <button onclick="flipHorizontal()">水平镜像</button>
          <button id="downloadBtn">下载</button>
          <button id="copyToClipboardBtn">复制到剪切板</button>
          <button onclick="flipVertical()">垂直镜像</button>
        </div>
      </div>
    </div>
    <div class="calculator" id="calculator">
      <h2>比例计算器</h2>
      <div class="input-group">
        <label>A = </label>
        <input type="number" id="valueA" step="any">
        <label>B = </label>
        <input type="number" id="valueB" step="any">
      </div>
      <div class="input-group">
        <label>C = </label>
        <input type="number" id="valueC" step="any" oninput="calculateFromC()">
        <label>D = </label>
        <input type="number" id="valueD" step="any" oninput="calculateFromD()">
      </div>
    </div>
  </div>
  <script>
    // 通用变量
    const fileInput = document.getElementById('fileInput');
    const canvas = document.createElement('canvas'); // 创建真正的画布
    const canvasContainer = document.querySelector('.canvas-container');
    const previewImage = document.getElementById('previewImage'); // 用于显示预览的图片
    const customWidthInput = document.getElementById('customWidth');
    const customHeightInput = document.getElementById('customHeight');
    const resolutionDisplay = document.querySelector('.resolution-display span');
    const imageEditor = document.getElementById('imageEditor');
    const calculator = document.getElementById('calculator');
    const toggleTabBtn = document.getElementById('toggleTabBtn');
    const darkModeToggle = document.getElementById('darkModeToggle');
    let isCalculatorVisible = false;

    // 图像编辑器相关变量
    let canvasWidth = 500; // 初始宽度
    let canvasHeight = 281.25; // 初始高度
    let aspectRatio = 16 / 9; // 默认比例
    let currentImage = null;
    let scale = 1;
    let rotation = 0;
    let isFlippedHorizontal = false;
    let isFlippedVertical = false;
    let offsetX = 0; // 图像偏移量X
    let offsetY = 0; // 图像偏移量Y
    let displayToCanvasScaleX = 1; // 显示到画布的比例X
    let displayToCanvasScaleY = 1; // 显示到画布的比例Y

    // 全局变量声明
    let imgPosition = { x: 0, y: 0 };
    let lastTouchDistance = 0;
    let initialScale = 1;

    // 初始化页面
    window.onload = function() {
      // 初始化画布
      updateCanvas();

      // 检查夜间模式
      const isNightMode = localStorage.getItem('nightMode') === 'true';
      if (isNightMode) {
        document.body.classList.add('night-mode');
        if (darkModeToggle) darkModeToggle.checked = true;
      }

      // 显示默认的图像编辑器
      showImageEditor();

      // 绑定事件
      toggleTabBtn.addEventListener('click', toggleTab);
      if (darkModeToggle) darkModeToggle.addEventListener('change', toggleBackground);
      document.getElementById('downloadBtn').addEventListener('click', downloadImage);
    };

    // 切换Tab
    function toggleTab() {
      if (isCalculatorVisible) {
        // 切换到图像编辑器
        calculator.style.display = 'none';
        imageEditor.style.display = 'flex';
        resolutionDisplay.parentElement.style.display = 'block'; // 显示分辨率信息
        toggleTabBtn.textContent = '切换到比例计算器';
      } else {
        // 切换到比例计算器
        calculator.style.display = 'block';
        imageEditor.style.display = 'none';
        resolutionDisplay.parentElement.style.display = 'none'; // 隐藏分辨率信息
        toggleTabBtn.textContent = '切换到图像编辑器';
      }
      isCalculatorVisible = !isCalculatorVisible;
    }

    // 切换背景颜色
    function toggleBackground() {
      document.body.classList.toggle('night-mode');
      const isNightMode = document.body.classList.contains('night-mode');
      localStorage.setItem('nightMode', isNightMode);
    }

    // 显示图像编辑器
    function showImageEditor() {
      calculator.style.display = 'none';
      imageEditor.style.display = 'flex';
      resolutionDisplay.parentElement.style.display = 'block';
    }

    // 更新真实画布尺寸以及预览画布尺寸
    function updateCanvas() {
      // 更新真实画布的尺寸
      canvas.width = canvasWidth;
      canvas.height = canvasHeight;

      // 限制画布容器的最大尺寸
      const maxContainerWidth = 500;
      const maxContainerHeight = 500;

      let containerWidth, containerHeight;

      if (aspectRatio >= 1) {
        // 宽 > 高
        containerWidth = Math.min(canvasWidth, maxContainerWidth);
        containerHeight = containerWidth / aspectRatio;
      } else {
        // 高 >= 宽
        containerHeight = Math.min(canvasHeight, maxContainerHeight);
        containerWidth = containerHeight * aspectRatio;
      }

      canvasContainer.style.width = `${containerWidth}px`;
      canvasContainer.style.height = `${containerHeight}px`;

      // 计算显示到画布的比例
      displayToCanvasScaleX = canvasWidth / containerWidth;
      displayToCanvasScaleY = canvasHeight / containerHeight;

      resolutionDisplay.textContent = `${canvasWidth} x ${canvasHeight}`;
      // 如果有当前图片，则重新绘制它
      if (currentImage) {
        drawImageOnCanvas();
      }
    }

    // 设置分辨率并调整画布
    function setResolution(width, height) {
      canvasWidth = width;
      canvasHeight = height;
      aspectRatio = width / height;
      updateCanvas();
    }

    // 设置自定义分辨率
    function setCustomResolution() {
      const width = parseInt(customWidthInput.value);
      const height = parseInt(customHeightInput.value);
      if (!isNaN(width) && !isNaN(height) && width > 0 && height > 0) {
        setResolution(width, height);
      } else {
        alert('请输入有效的宽度和高度');
      }
    }

    // 设置宽高比（保持当前宽度调整高度）
    function setAspectRatio(widthRatio, heightRatio) {
      aspectRatio = widthRatio / heightRatio;
      // 保持当前宽度不变,根据新的宽高比计算高度
      canvasHeight = Math.round(canvasWidth / aspectRatio);
      updateCanvas();
    }

    function flipHorizontal() {
      isFlippedHorizontal = !isFlippedHorizontal;
      drawImageOnCanvas();
    }

    function flipVertical() {
      isFlippedVertical = !isFlippedVertical;
      drawImageOnCanvas();
    }

    function rotateLeft() {
      rotation = (rotation - 90) % 360;
      drawImageOnCanvas();
    }

    function rotateRight() {
      rotation = (rotation + 90) % 360;
      drawImageOnCanvas();
    }

// 绘制图片到真实画布和预览画布上
function drawImageOnCanvas() {
      const ctx = canvas.getContext('2d');
      ctx.clearRect(0, 0, canvas.width, canvas.height);
      // 保存当前状态
      ctx.save();
      // 移动到画布中心并应用偏移量
      ctx.translate(canvasWidth / 2 + offsetX, canvasHeight / 2 + offsetY);
      // 旋转画布
      ctx.rotate(rotation * Math.PI / 180);
      // 翻转画布
      ctx.scale(isFlippedHorizontal ? -1 : 1, isFlippedVertical ? -1 : 1);
      // 绘制图片（考虑缩放）
      const imgWidth = currentImage.width * scale;
      const imgHeight = currentImage.height * scale;
      ctx.drawImage(currentImage, -imgWidth / 2, -imgHeight / 2, imgWidth, imgHeight);
      // 恢复到之前保存的状态
      ctx.restore();
      // 将真实画布的内容更新到预览画布上
      previewImage.src = canvas.toDataURL();
      previewImage.style.display = 'block'; // 确保图片显示
    }

      // 触摸开始事件
      canvasContainer.addEventListener('touchstart', function(e) {
          e.preventDefault();
          if (e.touches.length === 2) {
              // 双指缩放
              lastTouchDistance = getTouchDistance(e.touches);
              initialScale = scale;
          } else if (e.touches.length === 1) {
              // 单指拖动
              isDragging = true;
              startX = e.touches[0].clientX - offsetX;
              startY = e.touches[0].clientY - offsetY;
          }
      });

      // 触摸移动事件
      canvasContainer.addEventListener('touchmove', function(e) {
          e.preventDefault();
          if (e.touches.length === 2) {
              // 处理双指缩放
              const currentDistance = getTouchDistance(e.touches);
              const scaleFactor = currentDistance / lastTouchDistance;
              scale = initialScale * scaleFactor;
              scale = Math.min(Math.max(scale, 0.1), 5); // 限制缩放范围
              drawImageOnCanvas();
          } else if (e.touches.length === 1 && isDragging) {
              // 处理单指拖动
              offsetX = e.touches[0].clientX - startX;
              offsetY = e.touches[0].clientY - startY;
              drawImageOnCanvas();
          }
      });

      // 触摸结束事件
      canvasContainer.addEventListener('touchend', function(e) {
          isDragging = false;
          if (e.touches.length < 2) {
              lastTouchDistance = 0;
          }
      });

      // 触摸取消事件
      canvasContainer.addEventListener('touchcancel', function(e) {
          isDragging = false;
          lastTouchDistance = 0;
      });

      // 计算两个触摸点之间的距离
      function getTouchDistance(touches) {
          const dx = touches[0].clientX - touches[1].clientX;
          const dy = touches[0].clientY - touches[1].clientY;
          return Math.sqrt(dx * dx + dy * dy);
      }



    // 导入图片
    fileInput.addEventListener('change', (event) => {
      const file = event.target.files[0];
      if (file) {
        const reader = new FileReader();
        reader.onload = (e) => {
          currentImage = new Image();
          currentImage.src = e.target.result;
          currentImage.onload = () => {
            // 图片加载完成后更新画布
            setResolution(canvasWidth, canvasHeight);
            drawImageOnCanvas();
          };
        };
        reader.readAsDataURL(file);
      }
    });

    // 下载图片
    function downloadImage() {
      const link = document.createElement('a');
      link.download = `image.png`;
      link.href = canvas.toDataURL();
      link.click();
    }
    document.getElementById('copyToClipboardBtn').addEventListener('click', copyToClipboard);

    function copyToClipboard() {
      canvas.toBlob((blob) => {
        const item = new ClipboardItem({ 'image/png': blob });
        navigator.clipboard.write([item]).then(() => {
          alert('图像已复制到剪切板');
        }).catch((error) => {
          console.error('复制失败:', error);
        });
      });
    }

    // 鼠标滚轮事件处理缩放
    canvasContainer.addEventListener('wheel', (event) => {
      event.preventDefault();
      const zoomIntensity = 0.1;
      const delta = event.deltaY > 0 ? -zoomIntensity : zoomIntensity;
      scale = Math.max(0.1, scale + delta);
      drawImageOnCanvas();
    });

    // 鼠标按下事件处理
    canvasContainer.addEventListener('mousedown', (event) => {
      event.preventDefault();
      if (event.button === 0) { // 左键
        isDragging = true;
        startX = event.clientX;
        startY = event.clientY;
      } else if (event.button === 1) { // 中键
        isDragging = true;
        startX = event.clientX;
        startY = event.clientY;
      }
    });

    // 鼠标移动事件处理
    window.addEventListener('mousemove', (event) => {
      if (isDragging && currentImage) { // 确保有图片时才能拖动
        event.preventDefault();
        const dx = event.clientX - startX;
        const dy = event.clientY - startY;
        startX = event.clientX;
        startY = event.clientY;
        offsetX += dx * displayToCanvasScaleX;
        offsetY += dy * displayToCanvasScaleY;
        drawImageOnCanvas();
      }
    });

    // 鼠标松开事件处理
    window.addEventListener('mouseup', (event) => {
      if (event.button === 0 || event.button === 1) { // 左键或中键
        isDragging = false;
      }
    });

    // 防止鼠标中键点击时出现滚动符号
    window.addEventListener('click', (event) => {
      if (event.button === 1) {
        event.preventDefault();
      }
    });

    // 比例计算器功能
    function calculateFromC() {
      const a = parseFloat(document.getElementById('valueA').value);
      const b = parseFloat(document.getElementById('valueB').value);
      const c = parseFloat(document.getElementById('valueC').value);

      if (isNaN(a) || isNaN(b) || isNaN(c)) {
          return;
      }

      if (b === 0 || a === 0) {
          alert('分母不能为0！');
          return;
      }

      const d = Math.round((b * c) / a);
      document.getElementById('valueD').value = d;
    }
    function calculateFromD() {
      const a = parseFloat(document.getElementById('valueA').value);
      const b = parseFloat(document.getElementById('valueB').value);
      const d = parseFloat(document.getElementById('valueD').value);

      if (isNaN(a) || isNaN(b) || isNaN(d)) {
          return;
      }

      if (b === 0 || a === 0) {
          alert('分母不能为0！');
          return;
      }

      const c = Math.round((a * d) / b);
      document.getElementById('valueC').value = c;
    }

    function zoomInPixel() {
      if (currentImage) {
        scale += 0.01; // 每次增加0.01的缩放比例，大约相当于1像素
        drawImageOnCanvas();
      }
    }

    function zoomOutPixel() {
      if (currentImage && scale > 0.01) { // 防止缩放比例过小
        scale -= 0.01; // 每次减少0.01的缩放比例，大约相当于1像素
        drawImageOnCanvas();
      }
    }

    // 拖拽相关事件处理
    const dropZone = document.getElementById('dropZone');

    dropZone.addEventListener('dragover', (e) => {
      e.preventDefault();
      e.stopPropagation();
      dropZone.style.borderColor = '#4285f4';
    });

    dropZone.addEventListener('dragleave', (e) => {
      e.preventDefault();
      e.stopPropagation();
      dropZone.style.borderColor = '#ddd';
    });

    dropZone.addEventListener('drop', (e) => {
      e.preventDefault();
      e.stopPropagation();
      dropZone.style.borderColor = '#ddd';
      
      const file = e.dataTransfer.files[0];
      if (file && file.type.startsWith('image/')) {
        const reader = new FileReader();
        reader.onload = (e) => {
          currentImage = new Image();
          currentImage.src = e.target.result;
          currentImage.onload = () => {
            setResolution(canvasWidth, canvasHeight);
            drawImageOnCanvas();
          };
        };
        reader.readAsDataURL(file);
      }
    });

  </script>
</body>
</html>